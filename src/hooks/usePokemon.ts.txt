import { useQuery, useInfiniteQuery } from '@tanstack/react-query';
import { fetchPokemonList, fetchPokemonDetail, searchPokemon, fetchPokemonTypes } from '../utils/api';
import { Pokemon, SortOption, TypeFilter } from '../types/pokemon';
import { useDebounce } from './useDebounce';
import { useState, useEffect } from 'react';

export function usePokemon() {
  const [searchQuery, setSearchQuery] = useState('');
  const [typeFilter, setTypeFilter] = useState<TypeFilter>('all');
  const [sortBy, setSortBy] = useState<SortOption>('name');
  const [showFavorites, setShowFavorites] = useState(false);

  const debouncedSearch = useDebounce(searchQuery, 500);

  const { data: typesData } = useQuery({
    queryKey: ['pokemon-types'],
    queryFn: ({ signal }) => fetchPokemonTypes(signal),
  });

  const {
    data,
    fetchNextPage,
    hasNextPage,
    isFetchingNextPage,
    isLoading,
    error,
    refetch,
  } = useInfiniteQuery({
    queryKey: ['pokemon-list', debouncedSearch],
    queryFn: ({ pageParam = 0, signal }) => {
      if (debouncedSearch) {
        return searchPokemon(debouncedSearch, signal).then(pokemon => 
          pokemon ? { results: [pokemon], count: 1, next: null, previous: null } : { results: [], count: 0, next: null, previous: null }
        );
      }
      return fetchPokemonList(pageParam, 20, signal);
    },
    getNextPageParam: (lastPage, pages) => {
      if (debouncedSearch) return undefined;
      const totalFetched = pages.reduce((acc, page) => acc + page.results.length, 0);
      return totalFetched < (lastPage.count || 0) ? totalFetched : undefined;
    },
    initialPageParam: 0,
    staleTime: 5 * 60 * 1000,
  });

  const pokemonList = data?.pages.flatMap(page => page.results) || [];

  return {
    pokemonList,
    searchQuery,
    setSearchQuery,
    typeFilter,
    setTypeFilter,
    sortBy,
    setSortBy,
    showFavorites,
    setShowFavorites,
    types: typesData?.results || [],
    isLoading,
    error,
    fetchNextPage,
    hasNextPage,
    isFetchingNextPage,
    refetch,
  };
}

export function usePokemonDetail(id: string) {
  return useQuery({
    queryKey: ['pokemon-detail', id],
    queryFn: ({ signal }) => fetchPokemonDetail(id, signal),
    enabled: !!id,
    staleTime: 10 * 60 * 1000,
  });
}